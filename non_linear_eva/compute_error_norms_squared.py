import argparse
from pathlib import Path
from tqdm import tqdm
from load_save_dumps import load_dump, dump_object
from p1afempy.io_helpers import read_elements, read_coordinates
from p1afempy.solvers import evaluate_on_coordinates
from scipy.sparse import csr_matrix
from p1afempy.solvers import get_general_stiffness_matrix
from triangle_cubature.cubature_rule import CubatureRuleEnum
from problems import get_problem

def main() -> None:
    parser = argparse.ArgumentParser()
    parser.add_argument("--reference-solution", type=str, required=True)
    parser.add_argument("--reference-mesh", type=str, required=True)
    parser.add_argument("--problem", type=int, required=True)
    parser.add_argument("--results", type=str, required=True)
    args = parser.parse_args()

    problem = get_problem(number=args.problem)
    a_11 = problem.a_11
    a_12 = problem.a_12
    a_21 = problem.a_21
    a_22 = problem.a_22

    path_to_reference_solution = Path(args.reference_solution)
    path_to_results = Path(args.results)

    path_to_reference_mesh = Path(args.reference_mesh)
    path_to_reference_coordinates = path_to_reference_mesh / Path("coordinates.dat")
    path_to_reference_elements = path_to_reference_mesh / Path("elements.dat")

    reference_coordinates = read_coordinates(
        path_to_coordinates=path_to_reference_coordinates)
    # we shift the indices by +1 because the reference mesh
    # was generated by MATLAB code
    reference_elements = read_elements(
        path_to_elements=path_to_reference_elements, shift_indices=True)
    reference_solution =load_dump(path_to_dump=path_to_reference_solution)
    
    stiffness_matrix_graded_mesh = csr_matrix(get_general_stiffness_matrix(
            coordinates=reference_coordinates,
            elements=reference_elements,
            a_11=a_11, a_12=a_12, a_21=a_21, a_22=a_22,
            cubature_rule=CubatureRuleEnum.DAYTAYLOR
        ))

    for path_to_n_dofs in tqdm(list(path_to_results.iterdir())):
        if not path_to_n_dofs.is_dir():
            continue 

        path_to_results_coordinates = path_to_n_dofs / Path("coordinates.pkl")
        path_to_results_elements = path_to_n_dofs / Path("elements.pkl")
        path_to_results_solution = path_to_n_dofs / Path("last_iterate.pkl")

        results_coordinates = load_dump(path_to_dump=path_to_results_coordinates)
        results_elements = load_dump(path_to_dump=path_to_results_elements)
        results_solution = load_dump(path_to_dump=path_to_results_solution)

        print("evaluating last iterate on graded mesh")
        results_solution_on_reference_mesh = evaluate_on_coordinates(
            u=results_solution,
            elements=results_elements,
            coordinates=results_coordinates,
            r=reference_coordinates,
            display_progress_bar=True)

        du = results_solution_on_reference_mesh - reference_solution
        error_norm_squared = du.dot(stiffness_matrix_graded_mesh.dot(du))

        dump_object(
            obj=error_norm_squared,
            path_to_file=path_to_n_dofs / Path('energy_norm_error_squared.pkl'))


if __name__ == '__main__':
    main()

